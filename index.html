<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì—¬ë¦„ ì²­ì¶˜ ì‹œë®¬ë ˆì´í„°</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap');
  body {
    margin:0; padding:0;
    font-family: 'Gowun Dodum', sans-serif;
    background: #dbe9f4;
    color: #1b365d;
    display: flex; height: 100vh; overflow: hidden;
  }
  #leftPane {
    width: 38%; background: #f0f6fb;
    border-right: 2px solid #aac9e6;
    display: flex; flex-direction: column;
    padding: 12px;
    box-sizing: border-box;
  }
  #rightPane {
    width: 62%; padding: 16px;
    box-sizing: border-box;
    background: #e3f0fb;
    display: flex; flex-direction: column;
  }
  h1 {
    margin: 0 0 8px 0; font-weight: bold;
    font-size: 24px; text-align: center;
    color: #164a91;
  }
  h2 {
    margin: 8px 0;
    font-weight: 600;
    border-bottom: 1px solid #aac9e6;
    padding-bottom: 4px;
  }
  button {
    cursor: pointer;
    border: none;
    border-radius: 12px;
    padding: 6px 14px;
    background: #5290e9;
    color: white;
    font-weight: 600;
    transition: background 0.3s;
  }
  button:hover {
    background: #366ac3;
  }
  button:disabled {
    background: #a0b9de;
    cursor: default;
  }
  input[type="text"], input[type="number"], textarea {
    border: 1.5px solid #aac9e6;
    border-radius: 10px;
    padding: 6px 10px;
    font-size: 14px;
    width: 100%;
    box-sizing: border-box;
    font-family: 'Gowun Dodum', sans-serif;
    margin-bottom: 8px;
  }
  label {
    font-weight: 600;
    font-size: 14px;
  }
  .flexRow {
    display: flex; gap: 8px;
    align-items: center;
  }
  .student-list {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px 14px;
    overflow-y: auto;
    max-height: 370px;
    padding-right: 6px;
  }
  .student-card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    padding: 10px;
    font-size: 14px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  .student-name {
    font-weight: 700;
    margin-bottom: 4px;
    color: #0e2f66;
  }
  .student-info {
    font-size: 12px;
    color: #4a5f80;
    margin-bottom: 6px;
  }
  .btn-small {
    padding: 4px 10px;
    font-size: 13px;
    background: #3a7dd5;
  }
  .btn-small:hover {
    background: #2659a6;
  }
  .btn-danger {
    background: #d9534f;
  }
  .btn-danger:hover {
    background: #b6352b;
  }
  #charForm {
    background: #eef6fd;
    border-radius: 14px;
    padding: 12px;
    margin-bottom: 12px;
    box-shadow: inset 0 0 6px #c9ddf3;
  }
  #charForm label {
    display: block;
    margin-top: 6px;
  }
  #charForm textarea {
    resize: vertical;
    height: 60px;
  }
  .tag {
    background: #5290e9;
    border-radius: 10px;
    padding: 3px 8px;
    margin: 2px 4px 2px 0;
    color: white;
    display: inline-block;
    font-size: 12px;
    user-select: none;
  }
  .tag-container {
    margin-top: 4px;
    min-height: 22px;
  }
  #relationCanvas {
    background: #f7fbff;
    border-radius: 14px;
    box-shadow: 0 2px 6px #acc5e0;
  }
  #toggleRelationBtn, #toggleStudentListBtn {
    margin-bottom: 12px;
    background: #4a7fdb;
    border-radius: 12px;
  }
  #toggleRelationBtn:hover, #toggleStudentListBtn:hover {
    background: #2f5ebf;
  }
  #dateTitle {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 8px;
    text-align: center;
    color: #225090;
  }
  #dayLog {
    background: white;
    border-radius: 14px;
    padding: 10px;
    flex-grow: 1;
    overflow-y: auto;
    font-size: 14px;
    line-height: 1.5;
    box-shadow: inset 0 0 5px #c9ddf3;
  }
  .eventPopup {
    background: #cbe5fc;
    border-radius: 14px;
    padding: 10px 14px;
    margin: 8px 0;
    box-shadow: 0 0 10px #8eb6e3;
    color: #0d2e67;
    font-weight: 600;
  }
  .relationChangePopup {
    background: #f7c6c6;
    border-radius: 14px;
    padding: 10px 14px;
    margin: 8px 0;
    box-shadow: 0 0 12px #d15151;
    color: #7e1515;
    font-weight: 600;
  }
  #controls {
    display: flex;
    justify-content: space-between;
    margin-top: 12px;
  }
  .inline-flex {
    display: flex; gap: 6px; align-items: center;
  }
  .arrow-btn {
    background: #5290e9;
    border-radius: 12px;
    padding: 6px 12px;
    font-weight: 600;
    user-select: none;
    cursor: pointer;
    color: white;
  }
  .arrow-btn:disabled {
    background: #a0b9de;
    cursor: default;
  }
  .inline-input {
    width: 60px;
    text-align: center;
    font-size: 14px;
    border-radius: 8px;
    border: 1.5px solid #aac9e6;
    padding: 4px;
    font-family: 'Gowun Dodum', sans-serif;
  }
</style>
</head>
<body>
  <div id="leftPane">
    <h1>ì—¬ë¦„ ì²­ì¶˜ ì‹œë®¬ë ˆì´í„°</h1>
    <div class="flexRow" style="justify-content:center; margin-bottom:8px;">
      <button id="toggleStudentListBtn">í•™ìƒ ëª…ë‹¨ ë³´ê¸°</button>
      <button id="toggleRelationBtn">ê´€ê³„ë„ ë³´ê¸°</button>
    </div>
    <div id="studentManagement">
      <div id="studentList" class="student-list"></div>

      <form id="charForm">
        <h2 id="formTitle">ìºë¦­í„° ì¶”ê°€</h2>
        <label>ì´ë¦„ <input type="text" id="charName" required /></label>
        <label>ë‚˜ì´ <input type="number" id="charAge" min="10" max="30" value="16" required /></label>
        <label>í•™ë…„ 
          <select id="charGrade" required>
            <option value="1">1í•™ë…„</option>
            <option value="2">2í•™ë…„</option>
            <option value="3">3í•™ë…„</option>
            <option value="ì¡¸ì—…ìƒ">ì¡¸ì—…ìƒ</option>
          </select>
        </label>
        <label>ì„±ê²© í‚¤ì›Œë“œ <small>(Enterë¡œ ì¶”ê°€)</small></label>
        <input type="text" id="charTraitsInput" placeholder="ì˜ˆ: ë°ìŒ, ë‚´ì„±ì " />
        <div class="tag-container" id="charTraits"></div>
        <label>ì´ˆê¸° í˜¸ê°ë„ ì„¤ì •</label>
        <div id="initialLikesContainer"></div>
        <div style="margin-top:8px;">
          <button type="submit" id="addCharBtn">ì¶”ê°€</button>
          <button type="button" id="cancelEditBtn" style="display:none; margin-left: 6px;">ì·¨ì†Œ</button>
        </div>
      </form>
    </div>

    <canvas id="relationCanvas" width="380" height="400" style="display:none; margin-top: 12px;"></canvas>
  </div>

  <div id="rightPane">
    <div id="dateTitle">3ì›” 2ì¼ (ë´„) - ì…í•™ì‹</div>
    <div id="dayLog" tabindex="0" aria-label="í•˜ë£¨ ì¼ê³¼ ê¸°ë¡"></div>
    <div id="controls">
      <button id="nextDayBtn">ë‹¤ìŒ ë‚ </button>
      <button id="clearLogBtn" title="ê¸°ë¡ ì‚­ì œ (ì„œì‚¬ ìœ ì§€)">ğŸ—‘ï¸ ê¸°ë¡ ì‚­ì œ</button>
    </div>
  </div>

<script>
  // ì´ˆê¸° ìƒíƒœ
  const state = {
    currentDate: new Date(2024, 2, 2), // 3ì›” 2ì¼ ì‹œì‘ (ì›”ì€ 0ë¶€í„°)
    characters: [],
    logs: [],
    editingIndex: null,
    showRelation: false,
    events: [
      { start: '2024-04-21', end: '2024-04-24', name: '1í•™ê¸° ì¤‘ê°„ê³ ì‚¬' },
      { start: '2024-06-14', end: '2024-06-18', name: '1í•™ê¸° ê¸°ë§ê³ ì‚¬' },
      { start: '2024-07-02', end: '2024-08-01', name: 'ì—¬ë¦„ë°©í•™' },
      { start: '2024-08-23', end: '2024-08-25', name: 'ìˆ˜í•™ì—¬í–‰' },
      { start: '2024-09-04', end: '2024-09-04', name: 'ì²´ìœ¡ëŒ€íšŒ' },
      { start: '2024-10-21', end: '2024-10-25', name: '2í•™ê¸° ì¤‘ê°„ê³ ì‚¬' },
      { start: '2024-12-11', end: '2024-12-15', name: '2í•™ê¸° ê¸°ë§ê³ ì‚¬' },
      { start: '2025-02-14', end: '2025-02-14', name: 'ì¢…ì—…ì‹/ì¡¸ì—…ì‹' },
      { start: '2025-02-15', end: '2025-03-01', name: 'ë´„ë°©í•™' }
    ],
    seasons: ['ê²¨ìš¸', 'ë´„', 'ì—¬ë¦„', 'ê°€ì„'],
  };

  // í—¬í¼ - ë‚ ì§œ ë¬¸ìì—´ "YYYY-MM-DD"ë¡œ ë³€í™˜
  function toDateStr(date) {
    const y = date.getFullYear();
    const m = ('0' + (date.getMonth()+1)).slice(-2);
    const d = ('0' + date.getDate()).slice(-2);
    return `${y}-${m}-${d}`;
  }

  // í—¬í¼ - ê³„ì ˆ ë°˜í™˜
  function getSeason(date) {
    const m = date.getMonth()+1;
    if (m >= 3 && m <=5) return 'ë´„';
    if (m >= 6 && m <=8) return 'ì—¬ë¦„';
    if (m >= 9 && m <=11) return 'ê°€ì„';
    return 'ê²¨ìš¸';
  }

  // ì´ë²¤íŠ¸ ì—¬ë¶€ í™•ì¸
  function getEventForDate(date) {
    const ds = toDateStr(date);
    for (const e of state.events) {
      if (ds >= e.start && ds <= e.end) return e.name;
    }
    return null;
  }

  // í•™ë…„ ì „í™˜ ë° ì¡¸ì—… ì²˜ë¦¬
  function promoteGrades() {
    state.characters.forEach(c => {
      if(c.grade === 1) c.grade = 2;
      else if(c.grade === 2) c.grade = 3;
      else if(c.grade === 3) c.grade = 'ì¡¸ì—…ìƒ';
    });
  }

  // ê´€ê³„ ìƒíƒœ ê³„ì‚°
  function getRelationStatus(likeA, likeB) {
    if(likeA >= 80 && likeB >= 80) return 'ì•½í˜¼ì';
    if(likeA >= 50 && likeB >= 50) return 'ì—°ì¸';
    if(likeA >= 20 && likeB >= 20) return 'ì¸';
    if(likeA >= 20) return 'ì§ì‚¬ë‘';
    return 'ê´€ì‹¬ì—†ìŒ';
  }

  // íƒœê·¸ ì¶”ê°€ UI
  const charTraitsInput = document.getElementById('charTraitsInput');
  const charTraitsDiv = document.getElementById('charTraits');
  let currentTraits = [];

  charTraitsInput.addEventListener('keydown', e => {
    if(e.key === 'Enter' && charTraitsInput.value.trim() !== '') {
      e.preventDefault();
      addTrait(charTraitsInput.value.trim());
      charTraitsInput.value = '';
    }
  });

  function addTrait(trait){
    if(!currentTraits.includes(trait)){
      currentTraits.push(trait);
      renderTraits();
    }
  }

  function removeTrait(trait){
    currentTraits = currentTraits.filter(t => t !== trait);
    renderTraits();
  }

  function renderTraits(){
    charTraitsDiv.innerHTML = '';
    currentTraits.forEach(t => {
      const tag = document.createElement('span');
      tag.className = 'tag';
      tag.textContent = t;
      tag.onclick = () => removeTrait(t);
      charTraitsDiv.appendChild(tag);
    });
  }

  // ì´ˆê¸° í˜¸ê°ë„ ì„¤ì • UI ì—…ë°ì´íŠ¸
  const initialLikesContainer = document.getElementById('initialLikesContainer');
  function updateInitialLikesUI(){
    initialLikesContainer.innerHTML = '';
    state.characters.forEach(c => {
      const div = document.createElement('div');
      div.style.marginBottom = '4px';
      const label = document.createElement('label');
      label.textContent = `${c.name}ì— ëŒ€í•œ í˜¸ê°ë„: `;
      const input = document.createElement('input');
      input.type = 'number';
      input.min = -50;
      input.max = 100;
      input.value = 0;
      input.style.width = '50px';
      input.dataset.target = c.name;
      div.appendChild(label);
      div.appendChild(input);
      initialLikesContainer.appendChild(div);
    });
  }

  // ìºë¦­í„° ì¶”ê°€/ìˆ˜ì • í¼
  const charForm = document.getElementById('charForm');
  const charNameInput = document.getElementById('charName');
  const charAgeInput = document.getElementById('charAge');
  const charGradeSelect = document.getElementById('charGrade');
  const addCharBtn = document.getElementById('addCharBtn');
  const cancelEditBtn = document.getElementById('cancelEditBtn');
  const formTitle = document.getElementById('formTitle');

  // ê´€ê³„ë„ì™€ í•™ìƒëª…ë‹¨ í† ê¸€
  const toggleRelationBtn = document.getElementById('toggleRelationBtn');
  const toggleStudentListBtn = document.getElementById('toggleStudentListBtn');
  const relationCanvas = document.getElementById('relationCanvas');
  const studentListDiv = document.getElementById('studentList');

  toggleRelationBtn.addEventListener('click', () => {
    state.showRelation = true;
    renderRelationCanvas();
    relationCanvas.style.display = 'block';
    studentListDiv.style.display = 'none';
    toggleRelationBtn.disabled = true;
    toggleStudentListBtn.disabled = false;
  });
  toggleStudentListBtn.addEventListener('click', () => {
    state.showRelation = false;
    relationCanvas.style.display = 'none';
    studentListDiv.style.display = 'grid';
    toggleRelationBtn.disabled = false;
    toggleStudentListBtn.disabled = true;
  });

  // í•™ìƒ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
  function renderStudentList() {
    studentListDiv.innerHTML = '';
    state.characters.forEach((char, idx) => {
      const card = document.createElement('div');
      card.className = 'student-card';

      const nameDiv = document.createElement('div');
      nameDiv.className = 'student-name';
      nameDiv.textContent = char.name;
      card.appendChild(nameDiv);

      const infoDiv = document.createElement('div');
      infoDiv.className = 'student-info';
      infoDiv.textContent = `${char.age}ì„¸, ${char.grade} / ì„±ê²©: ${char.traits.join(', ') || 'ì—†ìŒ'}`;
      card.appendChild(infoDiv);

      // ì´ˆê¸° í˜¸ê°ë„ ìš”ì•½ í‘œì‹œ
      const likeSummary = [];
      for(const target of state.characters){
        if(char.relationships[target.name] !== undefined){
          likeSummary.push(`${target.name}: ${char.relationships[target.name]}`);
        }
      }
      const relDiv = document.createElement('div');
      relDiv.style.fontSize = '12px';
      relDiv.style.color = '#6a7a91';
      relDiv.textContent = 'í˜¸ê°ë„ â†’ ' + (likeSummary.length > 0 ? likeSummary.join(', ') : 'ì—†ìŒ');
      card.appendChild(relDiv);

      // ìˆ˜ì •, ì‚­ì œ ë²„íŠ¼
      const btnDiv = document.createElement('div');
      btnDiv.style.marginTop = '8px';
      const editBtn = document.createElement('button');
      editBtn.textContent = 'ìˆ˜ì •';
      editBtn.className = 'btn-small';
      editBtn.onclick = () => startEditCharacter(idx);
      btnDiv.appendChild(editBtn);

      const delBtn = document.createElement('button');
      delBtn.textContent = 'ì‚­ì œ';
      delBtn.className = 'btn-small btn-danger';
      delBtn.onclick = () => {
        if(confirm(`${char.name}ì„(ë¥¼) ì •ë§ ì‚­ì œí• ê¹Œìš”?`)){
          state.characters.splice(idx, 1);
          updateInitialLikesUI();
          renderStudentList();
          renderRelationCanvas();
        }
      };
      btnDiv.appendChild(delBtn);

      card.appendChild(btnDiv);

      studentListDiv.appendChild(card);
    });
  }

  // ìºë¦­í„° í¸ì§‘ ì‹œì‘
  function startEditCharacter(idx) {
    state.editingIndex = idx;
    const char = state.characters[idx];
    formTitle.textContent = 'ìºë¦­í„° ìˆ˜ì •';
    charNameInput.value = char.name;
    charAgeInput.value = char.age;
    charGradeSelect.value = char.grade;
    currentTraits = [...char.traits];
    renderTraits();

    // ì´ˆê¸° í˜¸ê°ë„ ì„¸íŒ… - ê° íƒ€ê²Ÿì— ë§ê²Œ ê°’ ì„¸íŒ…
    initialLikesContainer.innerHTML = '';
    state.characters.forEach(targetChar => {
      if(targetChar.name === char.name) return; // ìê¸° ìì‹  ì œì™¸
      const div = document.createElement('div');
      div.style.marginBottom = '4px';
      const label = document.createElement('label');
      label.textContent = `${targetChar.name}ì— ëŒ€í•œ í˜¸ê°ë„: `;
      const input = document.createElement('input');
      input.type = 'number';
      input.min = -50;
      input.max = 100;
      input.value = char.relationships[targetChar.name] || 0;
      input.style.width = '50px';
      input.dataset.target = targetChar.name;
      div.appendChild(label);
      div.appendChild(input);
      initialLikesContainer.appendChild(div);
    });

    addCharBtn.textContent = 'ì €ì¥';
    cancelEditBtn.style.display = 'inline-block';
  }

  // í¸ì§‘ ì·¨ì†Œ
  cancelEditBtn.addEventListener('click', () => {
    resetForm();
  });

  // í¼ ì´ˆê¸°í™”
  function resetForm(){
    charForm.reset();
    currentTraits = [];
    renderTraits();
    initialLikesContainer.innerHTML = '';
    state.editingIndex = null;
    formTitle.textContent = 'ìºë¦­í„° ì¶”ê°€';
    addCharBtn.textContent = 'ì¶”ê°€';
    cancelEditBtn.style.display = 'none';
    updateInitialLikesUI();
  }

  // ìºë¦­í„° ì¶”ê°€/ìˆ˜ì • ì œì¶œ ì²˜ë¦¬
  charForm.addEventListener('submit', e => {
    e.preventDefault();
    const name = charNameInput.value.trim();
    const age = parseInt(charAgeInput.value);
    let grade = charGradeSelect.value;
    if(['1','2','3'].includes(grade)) grade = parseInt(grade);

    if(!name) {
      alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    // ìƒˆ ìºë¦­í„° ìƒì„±
    const newChar = {
      name,
      age,
      grade,
      traits: [...currentTraits],
      relationships: {}, // ìƒëŒ€ í˜¸ê°ë„ ì´ˆê¸°í™”ëŠ” ì•„ë˜ì„œ
      status: 'ì •ìƒ', // ìƒíƒœ: ì •ìƒ, ì¡¸ì—…ìƒ ë“±
    };

    // í˜¸ê°ë„ ì´ˆê¸°ê°’ ì„¸íŒ…
    const inputs = initialLikesContainer.querySelectorAll('input[type=number]');
    inputs.forEach(input => {
      const target = input.dataset.target;
      const val = parseInt(input.value) || 0;
      newChar.relationships[target] = val;
    });

    if(state.editingIndex !== null){
      // ìˆ˜ì • ì¤‘ì´ë©´ ê¸°ì¡´ ë°ì´í„° ë®ì–´ì“°ê¸°
      // ì´ë¦„ ë°”ê¾¸ë©´ ê´€ê³„ë„ ì—…ë°ì´íŠ¸ í•„ìš”
      const oldName = state.characters[state.editingIndex].name;
      state.characters[state.editingIndex] = newChar;

      // ê´€ê³„ë„ì—ì„œ oldName í‚¤ë¥¼ ìƒˆ ì´ë¦„ìœ¼ë¡œ ë³€ê²½
      if(oldName !== newChar.name){
        state.characters.forEach(c => {
          if(c.relationships[oldName] !== undefined){
            c.relationships[newChar.name] = c.relationships[oldName];
            delete c.relationships[oldName];
          }
        });
      }
    } else {
      // ìƒˆë¡œ ì¶”ê°€ ì‹œ, ê¸°ì¡´ ìºë¦­í„°ë“¤ì˜ ê´€ê³„ë„ì— ìƒˆ ìºë¦­í„° ë°˜ì˜ (0ìœ¼ë¡œ)
      state.characters.forEach(c => {
        c.relationships[newChar.name] = 0;
      });
      state.characters.push(newChar);
    }

    resetForm();
    updateInitialLikesUI();
    renderStudentList();
    renderRelationCanvas();
  });

  // ë‚ ì§œì™€ ì´ë²¤íŠ¸ ì œëª© ì—…ë°ì´íŠ¸
  const dateTitle = document.getElementById('dateTitle');
  function updateDateTitle(){
    const season = getSeason(state.currentDate);
    const ymd = `${state.currentDate.getMonth()+1}ì›” ${state.currentDate.getDate()}ì¼ (${season})`;
    const eventName = getEventForDate(state.currentDate);
    dateTitle.textContent = eventName ? `${ymd} - ${eventName}` : ymd;
  }

  // ë¡œê·¸ ì¶œë ¥ì˜ì—­
  const dayLog = document.getElementById('dayLog');
  const nextDayBtn = document.getElementById('nextDayBtn');
  const clearLogBtn = document.getElementById('clearLogBtn');

  // ë¡œê·¸ì— í…ìŠ¤íŠ¸ ì¶”ê°€ (ì´ë²¤íŠ¸/ê´€ê³„ ë³€í™” ì‹œ ë‹¤ë¥´ê²Œ ì¶œë ¥)
  function addLogEntry(text, type='normal'){
    const p = document.createElement('p');
    p.textContent = text;
    if(type === 'event'){
      p.className = 'eventPopup';
    } else if(type === 'relationChange'){
      p.className = 'relationChangePopup';
    }
    dayLog.appendChild(p);
    dayLog.scrollTop = dayLog.scrollHeight;
  }

  // ê³ ë°± ì´ë²¤íŠ¸ ì²˜ë¦¬
  function handleConfession(charA, charB){
    if(charA.relationships[charB.name] >= 50 && charB.relationships[charA.name] >= 30){
      addLogEntry(`ğŸŒ¸ê´€ê³„ë„ ì´ë²¤íŠ¸ ë“±ì¥ğŸŒ¸\n${charA.name}ì€(ëŠ”) ${charB.name}ì—ê²Œ ê³ ë°±í–ˆê³ , ìƒëŒ€ë„ ë°›ì•„ì£¼ì—ˆìŠµë‹ˆë‹¤.`, 'event');
      // ì—°ì¸ ê´€ê³„ë¡œ ë³€í™”
      charA.relationships[charB.name] = 50;
      charB.relationships[charA.name] = 50;
      return true;
    }
    return false;
  }

  // ê´€ê³„ ë³€í™” ê²€ì‚¬ (í˜¸ê°ë„ ë³€í™” + ì´ë²¤íŠ¸ ë°œìƒ)
  function checkRelationshipChanges(){
    for(let i=0; i<state.characters.length; i++){
      const cA = state.characters[i];
      for(let j=0; j<state.characters.length; j++){
        if(i===j) continue;
        const cB = state.characters[j];
        const oldStatus = getRelationStatus(
          cA.relationships[cB.name] || 0,
          cB.relationships[cA.name] || 0);
        // í˜¸ê°ë„ ëœë¤ ê°ì†Œ 5% í™•ë¥ 
        if(Math.random() < 0.05 && (cA.relationships[cB.name] || 0) > 0){
          cA.relationships[cB.name] = Math.max(0, (cA.relationships[cB.name] || 0) - 1);
        }
        const newStatus = getRelationStatus(
          cA.relationships[cB.name] || 0,
          cB.relationships[cA.name] || 0);
        if(oldStatus !== newStatus){
          addLogEntry(`ğŸ’” ê´€ê³„ ë³€í™”: ${cA.name}ê³¼(ì™€) ${cB.name}ì€(ëŠ”) '${oldStatus}'ì—ì„œ '${newStatus}' ìƒíƒœê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'relationChange');
          // ê´€ê³„ ë³€í™” ì¶”ê°€ ì´ë²¤íŠ¸
          if(newStatus === 'ì¸'){
            addLogEntry(`${cA.name}ì€(ëŠ”) ${cB.name}ë¥¼ ë³¼ ë•Œë§ˆë‹¤ ì–´ì©ì§€ ê°€ìŠ´ í•œ ì¼ ì´ ì•„ë ¤ì˜¤ëŠ” ë“¯ í–ˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ìƒëŒ€ì—ê²Œ ë“¤í‚¤ê³  ì‹¶ì§€ ì•ŠìŠµë‹ˆë‹¤.`, 'event');
          }
        }
      }
    }
  }

  // í•˜ë£¨ ì¼ê³¼ ìƒì„± (ê³„ì ˆ+ì´ë²¤íŠ¸+ì„±ê²© ë°˜ì˜)
  function generateDailyNarrative(){
    const date = state.currentDate;
    const season = getSeason(date);
    const eventName = getEventForDate(date);

    const narratives = [];
    const chars = state.characters;

    // ê³„ì ˆë³„ ë¬¸ì¥ ì˜ˆì‹œ
    const seasonPhrases = {
      ë´„: ['ë”°ëœ»í•œ í–‡ì‚´ì´ êµì‹¤ì„ ê°ì‹¸ê³  ìˆì—ˆë‹¤.', 'ê½ƒë“¤ì´ ë§Œê°œí•´ í™œê¸°ê°€ ë„˜ì³¤ë‹¤.', 'ë¶€ë“œëŸ¬ìš´ ë´„ë°”ëŒì´ ë¶ˆì–´ì™”ë‹¤.'],
      ì—¬ë¦„: ['ë¬´ë”ìš´ í–‡ë³•ì´ í•™êµ ìš´ë™ì¥ì„ ë‚´ë¦¬ì¬ì—ˆë‹¤.', 'ì‹œì›í•œ ë°”ëŒì„ ê¸°ë‹¤ë¦¬ëŠ” í•™ìƒë“¤.', 'í–‡ë¹›ì´ ê°•í•˜ê²Œ ë‚´ë¦¬ì¬ëŠ” ì—¬ë¦„ë‚ .'],
      ê°€ì„: ['ë‚™ì—½ì´ ë°”ëŒì— í©ë‚ ë ¸ë‹¤.', 'ì‹œì›í•œ ê°€ì„ ê³µê¸°ê°€ êµì‹¤ ì•ˆì„ ê°ìŒŒë‹¤.', 'ë¶‰ì€ ë‹¨í’ìë“¤ì´ ë¹›ë‚˜ê³  ìˆì—ˆë‹¤.'],
      ê²¨ìš¸: ['ì°¨ê°€ìš´ ë°”ëŒì´ ë¶ˆì–´ì™”ë‹¤.', 'ëˆˆì´ ì†Œë³µì´ ìŒ“ì—¬ ì¡°ìš©í•œ í•™êµ.', 'ë”°ëœ»í•œ ë‚œë¡œ ê³ì— ëª¨ì—¬ë“¤ì—ˆë‹¤.'],
    };

    // ì´ë²¤íŠ¸ë³„ ë¬¸ì¥
    const eventPhrases = {
      'ì…í•™ì‹': 'ìƒˆë¡œìš´ ì‹œì‘ì„ ì•Œë¦¬ëŠ” ì…í•™ì‹ì´ ì—´ë ¸ë‹¤.',
      '1í•™ê¸° ì¤‘ê°„ê³ ì‚¬': '1í•™ê¸° ì¤‘ê°„ê³ ì‚¬ ê¸°ê°„ì´ë¼ ëª¨ë‘ê°€ ì—´ì‹¬íˆ ê³µë¶€ ì¤‘ì´ë‹¤.',
      '1í•™ê¸° ê¸°ë§ê³ ì‚¬': '1í•™ê¸° ê¸°ë§ê³ ì‚¬ë¥¼ ì•ë‘ê³  ê¸´ì¥ê°ì´ ëŒì•˜ë‹¤.',
      'ì—¬ë¦„ë°©í•™': 'ê¸°ë‹¤ë¦¬ë˜ ì—¬ë¦„ë°©í•™ì´ ì‹œì‘ë˜ì—ˆë‹¤.',
      'ìˆ˜í•™ì—¬í–‰': 'ìˆ˜í•™ì—¬í–‰ìœ¼ë¡œ ëª¨ë‘ê°€ ë“¤ë–  ìˆì—ˆë‹¤.',
      'ì²´ìœ¡ëŒ€íšŒ': 'ì²´ìœ¡ëŒ€íšŒì—ì„œ ì¹œêµ¬ë“¤ê³¼ ê²½ìŸí•˜ë©° ì¦ê±°ìš´ ì‹œê°„ì„ ë³´ëƒˆë‹¤.',
      '2í•™ê¸° ì¤‘ê°„ê³ ì‚¬': '2í•™ê¸° ì¤‘ê°„ê³ ì‚¬ë¥¼ ì¤€ë¹„í•˜ë©° ë°¤ë‚®ì—†ì´ ê³µë¶€í–ˆë‹¤.',
      '2í•™ê¸° ê¸°ë§ê³ ì‚¬': '2í•™ê¸° ê¸°ë§ê³ ì‚¬ê°€ ëë‚˜ê³  ëª¨ë‘ê°€ í•œìˆ¨ì„ ë‚´ì‰¬ì—ˆë‹¤.',
      'ì¢…ì—…ì‹/ì¡¸ì—…ì‹': 'í•œ í•´ì˜ ëì„ ì•Œë¦¬ëŠ” ì¢…ì—…ì‹ê³¼ ì¡¸ì—…ì‹ì´ ì§„í–‰ë˜ì—ˆë‹¤.',
      'ë´„ë°©í•™': 'ë´„ë°©í•™ ë™ì•ˆ íœ´ì‹ì„ ì·¨í•˜ë©° ì¬ì¶©ì „í–ˆë‹¤.'
    };

    // ê° ìºë¦­í„°ë³„ ëœë¤ ì„œìˆ  ë¬¸ì¥ (ì„±ê²© ë°˜ì˜)
    chars.forEach(char => {
      if(char.grade === 'ì¡¸ì—…ìƒ') return; // ì¡¸ì—…ìƒì€ ë”°ë¡œ ì²˜ë¦¬

      let traitPhrase = '';
      if(char.traits.length > 0){
        const trait = char.traits[Math.floor(Math.random()*char.traits.length)];
        traitPhrase = `${char.name}ì€(ëŠ”) ì˜¤ëŠ˜ë„ ${trait}í•œ ëª¨ìŠµìœ¼ë¡œ í•˜ë£¨ë¥¼ ë³´ëƒˆë‹¤.`;
      } else {
        traitPhrase = `${char.name}ì€(ëŠ”) í‰ë²”í•œ í•˜ë£¨ë¥¼ ë³´ëƒˆë‹¤.`;
      }
      narratives.push(traitPhrase);
    });

    // ê³„ì ˆ ë¬¸ì¥ 1ê°œ ëœë¤ ì¶”ê°€
    if(seasonPhrases[season]){
      narratives.unshift(seasonPhrases[season][Math.floor(Math.random()*seasonPhrases[season].length)]);
    }

    // ì´ë²¤íŠ¸ ë¬¸ì¥ ìˆìœ¼ë©´ ì•ì— ì¶”ê°€
    if(eventName && eventPhrases[eventName]){
      narratives.unshift(eventPhrases[eventName]);
    }

    return narratives.join(' ');
  }

  // 2ì›” 14ì¼ ì¡¸ì—…ì‹ ì§„ë¡œ ì§ˆë¬¸
  function showGraduationCareerQuestion(){
    let gradChars = state.characters.filter(c => c.grade === 3);
    if(gradChars.length === 0) return false;

    gradChars.forEach(char => {
      const careerQ = `ğŸŒ¸ ${char.name} ìºë¦­í„°ëŠ” ì´í›„ì— ì–´ë–»ê²Œ ë˜ì—ˆë‚˜ìš”?\n1. ëŒ€í•™êµì— ì…í•™í•œë‹¤.\n2. ëŒ€í•™êµì— ì…í•™í•˜ì§€ ì•Šì•˜ë‹¤.`;
      addLogEntry(careerQ, 'event');
      // ëŒ€í•™êµ ë¯¸ì…í•™ ì„ íƒì‹œ ì§ˆë¬¸ (ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ prompt ì‚¬ìš©)
      setTimeout(() => {
        const answer = prompt(`${char.name}ëŠ” ëŒ€í•™êµì— ì…í•™í–ˆë‚˜ìš”? (1: ì…í•™, 2: ë¯¸ì…í•™)`);
        if(answer === '2'){
          const job = prompt(`${char.name} ìºë¦­í„°ëŠ” ë¬´ì—‡ì´ ë˜ì—ˆë‚˜ìš”? ì§ì—…ì„ ì ì–´ì£¼ì„¸ìš”.`);
          addLogEntry(`${char.name}ì€(ëŠ”) ëŒ€í•™êµì— ì…í•™í•˜ì§€ ì•Šê³  '${job}'ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'event');
        } else if(answer === '1'){
          addLogEntry(`${char.name}ì€(ëŠ”) ëŒ€í•™êµì— ì…í•™í–ˆìŠµë‹ˆë‹¤.`, 'event');
        }
        char.grade = 'ì¡¸ì—…ìƒ'; // ì¡¸ì—… ì²˜ë¦¬
        renderStudentList();
      }, 200);
    });
    return true;
  }

  // ë‹¤ìŒ ë‚  ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
  nextDayBtn.addEventListener('click', () => {
    // 2ì›” 14ì¼ ì¡¸ì—…ì‹ ì§„ë¡œ ì§ˆë¬¸ ìš°ì„  ì²˜ë¦¬
    if(toDateStr(state.currentDate) === '2025-02-14'){
      const showed = showGraduationCareerQuestion();
      if(showed) return; // ì§ˆë¬¸ ë‚˜ì˜¤ë©´ ë‹¤ìŒë‚  ì§„í–‰ ì¤‘ë‹¨
    }

    // ë‚ ì§œ ì¦ê°€
    state.currentDate.setDate(state.currentDate.getDate()+1);

    // 1ì›” 1ì¼ì— í•™ë…„ ì§„ê¸‰ ì²˜ë¦¬ (ì—¬ê¸°ì„  ê°„ë‹¨í•˜ê²Œ 1ì›” 1ì¼ í•™ë…„ ìƒìŠ¹)
    if(state.currentDate.getMonth() === 0 && state.currentDate.getDate() === 1){
      promoteGrades();
      addLogEntry('ğŸ‰ ìƒˆí•´ê°€ ë˜ì–´ í•™ë…„ì´ ì§„ê¸‰í–ˆìŠµë‹ˆë‹¤!', 'event');
      renderStudentList();
    }

    updateDateTitle();

    // í•˜ë£¨ ì¼ê³¼ ìƒì„±
    const narrative = generateDailyNarrative();
    addLogEntry(narrative);

    // ê´€ê³„ ë³€í™” ê²€ì‚¬
    checkRelationshipChanges();

    // UI ê°±ì‹ 
    renderStudentList();
    renderRelationCanvas();
  });

  // ê¸°ë¡ ì‚­ì œ ë²„íŠ¼
  clearLogBtn.addEventListener('click', () => {
    if(confirm('ê¸°ë¡ë§Œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì„œì‚¬ëŠ” ìœ ì§€ë©ë‹ˆë‹¤.')){
      dayLog.innerHTML = '';
      state.logs = [];
    }
  });

  // ê´€ê³„ë„ ê·¸ë¦¬ê¸° í•¨ìˆ˜
  const relationCanvasCtx = relationCanvas.getContext('2d');
  function drawArrow(ctx, fromX, fromY, toX, toY) {
    const headlen = 10;
    const dx = toX - fromX;
    const dy = toY - fromY;
    const angle = Math.atan2(dy, dx);
    ctx.beginPath();
    ctx.moveTo(fromX, fromY);
    ctx.lineTo(toX, toY);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(toX, toY);
    ctx.lineTo(toX - headlen * Math.cos(angle - Math.PI / 6), toY - headlen * Math.sin(angle - Math.PI / 6));
    ctx.lineTo(toX - headlen * Math.cos(angle + Math.PI / 6), toY - headlen * Math.sin(angle + Math.PI / 6));
    ctx.lineTo(toX, toY);
    ctx.fill();
  }
  function renderRelationCanvas(){
    const ctx = relationCanvasCtx;
    const canvas = relationCanvas;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const radius = 25;
    const padding = 60;
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const count = state.characters.length;
    if(count === 0) return;
    const angleStep = (2 * Math.PI) / count;

    let positions = [];

    // ê° ìºë¦­í„° ìœ„ì¹˜ ê³„ì‚° (ì›í˜• ë°°ì¹˜)
    state.characters.forEach((char, i) => {
      const angle = i * angleStep - Math.PI / 2; // 12ì‹œ ë°©í–¥ë¶€í„° ì‹œì‘
      const x = centerX + Math.cos(angle) * (canvas.width/2 - padding);
      const y = centerY + Math.sin(angle) * (canvas.height/2 - padding);
      positions.push({x, y, name: char.name});
    });

    // ë…¸ë“œ ê·¸ë¦¬ê¸° (ì›ê³¼ ì´ë¦„)
    positions.forEach(pos => {
      ctx.fillStyle = '#bbe1fa';
      ctx.strokeStyle = '#3282b8';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.arc(pos.x, pos.y, radius, 0, 2 * Math.PI);
      ctx.fill();
      ctx.stroke();

      // ì´ë¦„ í…ìŠ¤íŠ¸
      ctx.fillStyle = '#0f4c75';
      ctx.font = '16px Gowun Dodum, sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(pos.name, pos.x, pos.y);
    });

    // ê´€ê³„ì„  (í™”ì‚´í‘œ) ë° í˜¸ê°ë„ í…ìŠ¤íŠ¸
    ctx.fillStyle = '#3282b8';
    ctx.strokeStyle = '#3282b8';
    ctx.lineWidth = 2;
    ctx.font = '14px Gowun Dodum, sans-serif';

    state.characters.forEach((char, i) => {
      const from = positions[i];
      Object.entries(char.relationships).forEach(([targetName, val]) => {
        if(val !== undefined && val !== null && val !== 0){
          const j = positions.findIndex(p => p.name === targetName);
          if(j !== -1){
            const to = positions[j];
            // í™”ì‚´í‘œ ì‹œì‘ì , ëì  ë³´ì • (ì› ë°–ì—ì„œ ì‹œì‘, ì› ë°–ì—ì„œ ëë‚˜ë„ë¡)
            const angle = Math.atan2(to.y - from.y, to.x - from.x);
            const startX = from.x + radius * Math.cos(angle);
            const startY = from.y + radius * Math.sin(angle);
            const endX = to.x - radius * Math.cos(angle);
            const endY = to.y - radius * Math.sin(angle);

            // í˜¸ê°ë„ì— ë”°ë¼ ì„  ìƒ‰ê¹” ì§€ì • (50 ì´ìƒì€ íŒŒë€ìƒ‰, ìŒìˆ˜ëŠ” ë¶‰ì€ìƒ‰)
            if(val >= 50){
              ctx.strokeStyle = '#1463bf';
              ctx.fillStyle = '#1463bf';
            } else if(val < 0) {
              ctx.strokeStyle = '#d14646';
              ctx.fillStyle = '#d14646';
            } else {
              ctx.strokeStyle = '#82a4d4';
              ctx.fillStyle = '#82a4d4';
            }

            // ì„  ê·¸ë¦¬ê¸°
            drawArrow(ctx, startX, startY, endX, endY);

            // í˜¸ê°ë„ í…ìŠ¤íŠ¸ ìœ„ì¹˜ (ì¤‘ê°„ + ì•½ê°„ ìœ„)
            const midX = (startX + endX) / 2;
            const midY = (startY + endY) / 2 - 10;
            ctx.fillText(val, midX, midY);
          }
        }
      });
    });
  }

  // ì´ˆê¸° ì„¸íŒ…
  function init(){
    updateDateTitle();
    resetForm();
    updateInitialLikesUI();
    renderStudentList();
    toggleStudentListBtn.disabled = true;
  }

  init();
</script>

</body>
</html>
